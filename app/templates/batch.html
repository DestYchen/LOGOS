<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>SupplyHub — Партия {{ batch_id }}</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 2rem; }
      h1 { margin-bottom: 0.5rem; }
      .status { margin-bottom: 1.5rem; }
      .docs { margin-top: 2rem; }
      pre { background: #f5f5f5; padding: 1rem; border-radius: 6px; overflow-x: auto; white-space: pre-wrap; }
      .meta { color: #666; font-size: 0.9rem; }
      .report { margin-top: 2rem; }
      .back { margin-top: 2rem; display: inline-block; }
      .pending { color: #d97706; }
      .ready { color: #047857; }
      .alert { padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 1rem; max-width: 640px; }
      .alert.info { background: #ecfdf5; color: #047857; border: 1px solid #6ee7b7; }
      .alert.error { background: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; }
      .actions { margin-top: 1.5rem; }
      button { background-color: #2563eb; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 4px; cursor: pointer; }
      button:hover { background-color: #1e4ecf; }
      table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
      th, td { border: 1px solid #e5e7eb; padding: 0.5rem 0.75rem; text-align: left; font-size: 0.95rem; vertical-align: top; }
      th { background: #f3f4f6; }
      .products-table { margin-top: 0.75rem; }
      .products-table th, .products-table td { font-size: 0.9rem; }
      .product-id-cell { font-weight: 600; white-space: nowrap; }
      .cell-missing { background: #fef2f2; color: #991b1b; }
      .meta-conf { display: block; font-size: 0.75rem; color: #6b7280; margin-top: 0.2rem; }
      .small-btn { padding: 0.35rem 0.8rem; font-size: 0.85rem; }
      .field-actions form { display: inline-flex; gap: 0.4rem; margin-right: 0.5rem; margin-top: 0.25rem; align-items: center; }
      .field-actions input[type="text"] { padding: 0.35rem 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem; }
      .set-type { margin: 0.75rem 0; }
      .set-type-form { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
      .set-type-form label { font-size: 0.9rem; }
      .set-type-form select { padding: 0.35rem 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem; }
      .comparison-list { margin: 0; padding-left: 1.25rem; font-size: 0.9rem; color: #374151; }
      .validation-matrix td { white-space: pre-line; }
      .report-actions { margin: 0.75rem 0; }
      a.small-btn { display: inline-block; text-decoration: none; }
      .previews { margin: 0.75rem 0 1rem; display: flex; flex-wrap: wrap; gap: 0.75rem; }
      .previews img { max-width: 480px; height: auto; border: 1px solid #e5e7eb; border-radius: 4px; }
    </style>
  </head>
  <body>
    <h1>Партия {{ batch_id }}</h1>
    <div class="back">
      <a href="/web/batches">← Ко всем Партиям</a>
    </div>

    {% if message == 'review_completed' %}
      <div class="alert info">Ревью завершено, отчёт появится после завершения проверки.</div>
    {% elif message == 'type_set' %}
      <div class="alert info">Document type updated. Fields will be refilled automatically.</div>
    {% elif message in ['field_confirmed', 'field_saved'] %}
      <div class="alert info">Изменения сохранены.</div>
    {% endif %}
    {% if error == 'review_not_ready' %}
      <div class="alert error">Сначала подтвердите или заполните все обязательные поля.</div>
    {% elif error == 'field_missing' %}
      <div class="alert error">Невозможно подтвердить пустое поле — введите значение.</div>
    {% endif %}

    <div class="status">
      {% set warnings = processing_warnings | default([], true) %}
      {% if warnings %}
        <div class="alert error">
          <strong>Предупреждения обработки:</strong>
          <ul>
            {% for w in warnings %}
              <li>{{ w }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
      <strong>Статус:</strong>
      {% if status in ["FILLED_AUTO", "FILLED_REVIEWED", "VALIDATED", "DONE"] %}
        <span class="ready">{{ status }}</span>
      {% else %}
        <span class="pending">{{ status }}</span>
      {% endif %}
      <div class="meta">Документов загружено: {{ documents|length }}</div>
    </div>

    <div class="docs">
      {% for doc in documents %}
        <form action="/web/documents/{{ doc.id }}/delete" method="post" onsubmit="return confirm('Удалить документ из партии? Это действие необратимо.');" style="margin: 0.25rem 0 0.75rem;">
          <button class="small-btn" type="submit">Удалить документ</button>
        </form>
        <h2>Документ: {{ doc.filename }}</h2>
        <div class="meta">Тип: {{ doc.doc_type }} · Статус: {{ doc.status }}</div>
        {% if doc.previews and doc.previews|length > 0 %}
          <div class="previews">
            {% for url in doc.previews %}
              <img src="{{ url }}" alt="preview {{ loop.index }} for {{ doc.filename }}" />
            {% endfor %}
          </div>
        {% endif %}
        {% if doc.doc_type == "UNKNOWN" and doc.status == "FAILED" %}
          <div class="set-type">
            <form action="/web/documents/{{ doc.id }}/set_type" method="post" class="set-type-form">
              <label for="doc-type-{{ loop.index0 }}">Select document type:</label>
              <select id="doc-type-{{ loop.index0 }}" name="doc_type">
                {% for value in doc_types %}
                  {% if value != "UNKNOWN" %}
                    <option value="{{ value }}">{{ value }}</option>
                  {% endif %}
                {% endfor %}
              </select>
              <button class="small-btn" type="submit">Apply</button>
            </form>
          </div>
        {% endif %}
        {% if doc.doc_type != "UNKNOWN" %}
          <div class="set-type">
            <form action="/web/documents/{{ doc.id }}/set_type" method="post" class="set-type-form">
              <label for="doc-change-type-{{ loop.index0 }}">Сменить тип и перезаполнить:</label>
              <select id="doc-change-type-{{ loop.index0 }}" name="doc_type">
                {% for value in doc_types %}
                  {% if value != "UNKNOWN" %}
                    <option value="{{ value }}" {% if value == doc.doc_type %}selected{% endif %}>{{ value }}</option>
                  {% endif %}
                {% endfor %}
              </select>
              <button class="small-btn" type="submit">Применить</button>
            </form>
          </div>
        {% endif %}
        {% if doc.doc_type != "UNKNOWN" %}
          <div class="set-type">
            <form action="/web/documents/{{ doc.id }}/refill" method="post" class="set-type-form">
              <label>Перезаполнить поля с текущим типом ({{ doc.doc_type }}):</label>
              <button class="small-btn" type="submit">Перезаполнить</button>
            </form>
          </div>
        {% endif %}
        {% if doc.processing and doc.status != "FAILED" %}
          <p class="meta">Документ ещё обрабатывается. Подождите завершения обработки перед подтверждением полей.</p>
        {% endif %}

        <h3>Поля</h3>
        <table>
          <thead>
            <tr>
              <th>Поле</th>
              <th>Значение</th>
              <th>Уверенность</th>
              <th>Состояние</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for field in doc.fields %}
              <tr>
                <td>{{ field.field_key }}{% if field.required %} *{% endif %}</td>
                <td>{{ field.value if field.value is not none else '—' }}</td>
                <td>{{ field.confidence_display if field.confidence_display else '—' }}</td>
                <td>
                  {% if field.reason == 'missing' %}
                    Не заполнено
                  {% elif field.reason == 'unknown_type' %}
                    Тип документа не распознан
                  {% elif field.reason == 'low_confidence' %}
                    Низкая уверенность
                  {% elif field.reason == 'extra' %}
                    Дополнительное поле
                  {% else %}
                    Подтверждено
                  {% endif %}
                </td>
                <td class="field-actions">
                  {% if field.actionable %}
                    <form action="/web/documents/{{ field.doc_id }}/fields/{{ field.field_key }}/confirm" method="post">
                      <button class="small-btn" type="submit">Подтвердить</button>
                    </form>
                  {% endif %}
                  {% if field.editable %}
                    <form action="/web/documents/{{ field.doc_id }}/fields/{{ field.field_key }}/update" method="post">
                      <input type="text" name="value" value="{{ field.value or '' }}" {% if field.required %}required{% endif %} placeholder="Введите значение" />
                      <button class="small-btn" type="submit">Сохранить</button>
                    </form>
                  {% elif field.needs_confirmation and not field.actionable %}
                    Требуется корректировка
                  {% elif not field.actionable %}
                    —
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        {% if doc.products.columns %}
          <div class="products-block">
            <h3>Продукты</h3>
            {% if doc.products.rows %}
              <table class="products-table">
                <thead>
                  <tr>
                    <th>Идентификатор</th>
                    {% for column in doc.products.columns %}
                      <th>{{ column.label }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for row in doc.products.rows %}
                    <tr>
                      <td class="product-id-cell">{{ row.product_id }}</td>
                      {% for cell in row.fields %}
                        <td class="{% if cell.missing %}cell-missing{% endif %}">
                          {{ cell.value if cell.value is not none and cell.value != '' else '—' }}
                          {% if cell.confidence_display %}
                            <span class="meta-conf">{{ cell.confidence_display }}</span>
                          {% endif %}
                        </td>
                      {% endfor %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <p class="meta">Продукты не найдены.</p>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <div class="actions">
      {% if can_complete %}
        <form action="/web/batches/{{ batch_id }}/complete" method="post">
          <button type="submit">Подтвердить ревью и запустить проверку</button>
        </form>
      {% else %}
        <p class="meta">Чтобы перейти к сверке, дождитесь завершения обработки и закройте вопросы по полям.</p>
        {% if awaiting_processing %}
          <p class="meta">Некоторые документы ещё обрабатываются.</p>
        {% endif %}
        {% if pending_total > 0 %}
          <p class="meta">Осталось подтвердить {{ pending_total }} поле(й).</p>
        {% endif %}
      {% endif %}
    </div>

    <div class="report">
      <h2>Отчёт проверки</h2>
      {% if report_available %}
        <div class="report-actions">
          <a class="small-btn" href="/web/batches/{{ batch_id }}/report.xlsx">Скачать отчёт (Excel)</a>
        </div>
        <h3>Документы</h3>
        {% if report_documents %}
          <table>
            <thead>
              <tr>
                <th>Документ</th>
                <th>Тип</th>
                <th>Статус</th>
                <th>Поле</th>
                <th>Значение</th>
                <th>Уверенность</th>
                <th>Источник</th>
                <th>Страница</th>
              </tr>
            </thead>
            <tbody>
              {% for row in report_documents %}
                <tr>
                  <td>{{ row.filename }}</td>
                  <td>{{ row.doc_type }}</td>
                  <td>{{ row.status }}</td>
                  <td>{{ row.field_key or '-' }}</td>
                  <td>{{ row.value if row.value is not none else '-' }}</td>
                  <td>{{ row.confidence if row.confidence is not none else '-' }}</td>
                  <td>{{ row.source or '-' }}</td>
                  <td>{{ row.page if row.page is not none else '-' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="meta">Заполненных полей нет.</p>
        {% endif %}
        <h3>Замечания и проверки</h3>
        {% if validation_matrix %}
          <table class="validation-matrix">
            <thead>
              <tr>
                <th>??????</th>
                <th>???????? ???????</th>
                {% for column in validation_matrix_columns %}
                  <th>{{ column.label }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in validation_matrix %}
                <tr>
                  <td>{{ row.severity or '-' }}</td>
                  <td>
                    <div><strong>{{ row.rule_id }}</strong></div>
                    <div>{{ row.message or '?' }}</div>
                  </td>
                  {% for column in validation_matrix_columns %}
                    {% set cell = row.cells.get(column.key) %}
                    <td>{{ cell if cell else '?' }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% elif report_validations %}
          <table>
            <thead>
              <tr>
                <th>???????</th>
                <th>???????</th>
                <th>?????????</th>
                <th>??????</th>
              </tr>
            </thead>
            <tbody>
              {% for validation in report_validations %}
                <tr>
                  <td>{{ validation.rule_id }}</td>
                  <td>{{ validation.severity }}</td>
                  <td>{{ validation.message }}</td>
                  <td>{{ validation.refs or '-' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="meta">????????? ?? ???????.</p>
        {% endif %}


        <h3>?????? ?????????</h3>

        {% if product_matrix %}
          <table class="product-matrix">
            <thead>
              <tr>
                <th>Статус</th>
                <th>Описание правила</th>
                {% for column in product_matrix_columns %}
                  <th>{{ column.label }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in product_matrix %}
                <tr>
                  <td>{{ row.severity or '-' }}</td>
                  <td>
                    <div><strong>{{ row.rule_id }}</strong></div>
                    <div>{{ row.message or '-' }}</div>
                  </td>
                  {% for column in product_matrix_columns %}
                    {% set cell = row.cells.get(column.key) %}
                    <td>{{ cell if cell else '-' }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="meta">Расхождения по продуктам не обнаружены.</p>
        {% endif %}
        {% if report_json %}
          <details>
            <summary>Показать исходный JSON</summary>
            <pre>{{ report_json }}</pre>
          </details>
        {% endif %}
      {% else %}
        <p>Отчёт появится после завершения проверки.</p>
      {% endif %}
    </div>

    <div class="back">
      <a href="/web/upload">← Загрузить ещё</a>
    </div>
  </body>
</html>
